(function(){var autocomplete_data={};var DOWN_ARROW_KEY=40;var UP_ARROW_KEY=38;var ESC_KEY=27;var ENTER_KEY=13;tinymce.create('tinymce.plugins.AutoCompletePlugin',{init:function(ed,url){autocomplete_data={list:createOptionList(),visible:false,cancelEnter:false,delimiter:ed.getParam('autocomplete_delimiters','160,32').split(","),matchingOptions:ed.getParam('autocomplete_matching_options'),asString:ed.getParam('autocomplete_as_string'),trigger:ed.getParam('autocomplete_trigger','@')};function keyUpEvent(ed,e){var keyCode=e.keyCode;if((!autocomplete_data.visible&&keyCode!=ESC_KEY&&keyCode!=ENTER_KEY)||(keyCode!=DOWN_ARROW_KEY&&keyCode!=UP_ARROW_KEY&&keyCode!=ENTER_KEY&&keyCode!=ESC_KEY)){var currentWord=getCurrentWord(ed);if(currentWord.length>0){populateList(currentWord)}else{hideOptionList()}}}function populateList(currentWord){var wordLessTrigger=currentWord.replace(autocomplete_data.trigger,"");matches=autocomplete_data.matchingOptions(wordLessTrigger);if(matches.length>0){displayOptionList(matches,wordLessTrigger,ed);highlightNextOption()}else{hideOptionList()}}function keyPressEvent(ed,e){if(e.keyCode==ENTER_KEY&&autocomplete_data.cancelEnter){autocomplete_data.cancelEnter=false;return tinymce.dom.Event.cancel(e)}}function keyDownEvent(ed,e){if(autocomplete_data.visible){if(e.keyCode==DOWN_ARROW_KEY){highlightNextOption();return tinymce.dom.Event.cancel(e)}if(e.keyCode==UP_ARROW_KEY){highlightPreviousOption();return tinymce.dom.Event.cancel(e)}if(e.keyCode==ENTER_KEY){selectOption(ed);autocomplete_data.cancelEnter=true;return false}if(e.keyCode==ESC_KEY){hideOptionList();return tinymce.dom.Event.cancel(e)}}}function clickEvent(ed,e){hideOptionList()}function displayOptionList(matches,matchedText,ed){var list=jQuery('<ul class="auto-list"></ul>');for(var i in matches){jQuery('<li></li>').prop('data-value',matches[i]).prop('data-matched-text',matchedText).text(matches[i].description).appendTo(list)}autocomplete_data.list.replaceWith(list);autocomplete_data.list=list;var container=jQuery(ed.getContainer());var tinymcePosition=container.offset();var toolbarPosition=container.find(".mceToolbar").first();var textareaTop=0;var textareaLeft=0;var range=ed.selection.getRng();if(jQuery.browser.msie){this.range=range}var rangeStart=range.startOffset;range.setStart(range.startContainer,range.startOffset-1);var rects=range.getClientRects();range.setStart(range.startContainer,rangeStart);if(rects.length>0){var rect=rects[0];textareaTop=rect.top+rect.height;textareaLeft=rect.left}var win=$(window);var top=tinymcePosition.top-win.scrollTop()+toolbarPosition.innerHeight()+textareaTop;if(top+list.height()>win.height()){list.css("top","");list.css("bottom",0)}else{list.css("top",top);list.css("bottom","")}var left=tinymcePosition.left-win.scrollLeft()+textareaLeft;if(left+list.width()>win.width()){list.css("left","");list.css("right",0)}else{list.css("left",left);list.css("right","")}list.css("left",left);list.css("display","block");autocomplete_data.visible=true;optionListEventHandlers(ed)}function optionListEventHandlers(ed){jQuery(autocomplete_data.list).find("li").hover(function(){jQuery(autocomplete_data.list).find("[data-selected=true]").attr("data-selected","false");jQuery(this).attr("data-selected","true")});jQuery(autocomplete_data.list).find("li").click(function(){selectOption(ed)})}function createOptionList(){var list=jQuery('ul.auto-list');if(list.length>0){return list.first()}return jQuery('<ul class="auto-list"></ul>').appendTo($(document.body))}function hideOptionList(){autocomplete_data.list.css("display","none");autocomplete_data.visible=false}function highlightNextOption(){var current=autocomplete_data.list.find("[data-selected=true]");if(current.size()==0||current.next().size()==0){autocomplete_data.list.find("li:first-child").attr("data-selected","true")}else{current.next().attr("data-selected","true")}current.attr("data-selected","false")}function highlightPreviousOption(){var current=autocomplete_data.list.find("[data-selected=true]");if(current.size()==0||current.prev().size()==0){autocomplete_data.list.find("li:last-child").attr("data-selected","true")}else{current.prev().attr("data-selected","true")}current.attr("data-selected","false")}function selectOption(ed){var list=autocomplete_data.list;var selectedItem=list.find("[data-selected=true]");if(!selectedItem){selectedItem=list.find("li:first-child")}var current=selectedItem.prop("data-value");var matchedText=autocomplete_data.trigger+selectedItem.prop("data-matched-text");current=autocomplete_data.asString(current);var delim="";if(autocomplete_data.delimiter.length>0){delim=String.fromCharCode(autocomplete_data.delimiter[0])}var text=current.toString()+delim;var range=null;if(jQuery.browser.msie){range=this.range}if(!range){range=ed.selection.getRng()}range.setStart(range.startContainer,range.startOffset-matchedText.length);ed.selection.setRng(range);ed.execCommand('mceInsertContent',false,text);hideOptionList();if(jQuery.browser.webkit||jQuery.browser.mozilla){ed.focus()}}function getCurrentWord(ed){var sel=ed.selection.getSel();var nodeText=sel.focusNode==null?"":sel.focusNode.nodeValue;var positionInNode=sel.focusOffset;if(nodeText==null||nodeText.length==0){return""}var lastDelimiter=positionInNode;var delimiter=autocomplete_data.delimiter;while(lastDelimiter--){if(delimiter.indexOf(nodeText.charCodeAt(lastDelimiter).toString())>=0){break}}var word=nodeText.substr(lastDelimiter+1,positionInNode-lastDelimiter-1);if(word.length>0&&word.charAt(0).toString()==autocomplete_data.trigger){return word}return""}ed.onKeyUp.addToTop(keyUpEvent);ed.onKeyDown.addToTop(keyDownEvent);ed.onKeyPress.addToTop(keyPressEvent);ed.onClick.add(clickEvent);ed.onPostRender.add(function(){tinymce.dom.Event.add(ed.getWin(),'blur',function(e){setTimeout(hideOptionList,500)})})},getInfo:function(){return{longname:'AutoComplete',author:'Mijura Pty Ltd',authorurl:'http://mijura.com',infourl:'http://blog.mijura.com',version:tinymce.majorVersion+"."+tinymce.minorVersion}}});tinymce.PluginManager.add('autocomplete',tinymce.plugins.AutoCompletePlugin)})();