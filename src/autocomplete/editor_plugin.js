(function(){var autocomplete_data={};var DOWN_ARROW_KEY=40;var UP_ARROW_KEY=38;var ESC_KEY=27;var ENTER_KEY=13;function parseOptions(param){return param.options==null?param.split(","):param.options}tinymce.create('tinymce.plugins.AutoCompletePlugin',{setOptions:function(param){autocomplete_data.options=parseOptions(param)},getOptions:function(){return autocomplete_data.options},init:function(ed,url){autocomplete_data={list:createOptionList(),visible:false,cancelEnter:false,delimiter:ed.getParam('autocomplete_delimiters','160,32').split(","),options:parseOptions(ed.getParam('autocomplete_options','')),trigger:ed.getParam('autocomplete_trigger','@'),enclosing:ed.getParam('autocomplete_end_option',''),minLength:ed.getParam('autocomplete_min_length','3'),onSelect:ed.getParam('autocomplete_on_select',false)};var t=this;if(autocomplete_data.onSelect){t.onSelect=new tinymce.util.Dispatcher(t);t.onSelect.add(function(ed,selected){ed.execCallback('autocomplete_on_select',ed,selected)})}function keyUpEvent(ed,e){if((!autocomplete_data.visible&&e.keyCode!=ESC_KEY&&e.keyCode!=ENTER_KEY)||(e.keyCode!=DOWN_ARROW_KEY&&e.keyCode!=UP_ARROW_KEY&&e.keyCode!=ENTER_KEY&&e.keyCode!=ESC_KEY)){var currentWord=getCurrentWord(ed);var matches=[];if(currentWord.length>0){var wordLessTrigger=currentWord.replace(autocomplete_data.trigger,"");matches=matchingOptions(wordLessTrigger);if(matches.length>0){displayOptionList(matches,wordLessTrigger,ed);highlightNextOption()}}if(currentWord.length==0||matches.length==0){hideOptionList()}}}function keyPressEvent(ed,e){if(e.keyCode==ENTER_KEY&&autocomplete_data.cancelEnter){autocomplete_data.cancelEnter=false;return tinymce.dom.Event.cancel(e)}}function keyDownEvent(ed,e){if(autocomplete_data.visible){if(e.keyCode==DOWN_ARROW_KEY){highlightNextOption();return tinymce.dom.Event.cancel(e)}if(e.keyCode==UP_ARROW_KEY){highlightPreviousOption();return tinymce.dom.Event.cancel(e)}if(e.keyCode==ENTER_KEY){selectOption(ed,getCurrentWord(ed));autocomplete_data.cancelEnter=true;return}if(e.keyCode==ESC_KEY){hideOptionList();return tinymce.dom.Event.cancel(e)}}}function clickEvent(ed,e){hideOptionList()}function displayOptionList(matches,matchedText,ed){var matchesList="";var highlightRegex=new RegExp("("+matchedText+")");for(var i in matches){if(matches[i].key!=null){matchesList+="<li data-value='"+matches[i].key+"'>"+matches[i].key.replace(highlightRegex,"<mark>$1</mark>")+" "+matches[i].description+"</li>"}else{matchesList+="<li data-value='"+matches[i]+"'>"+matches[i].replace(highlightRegex,"<mark>$1</mark>")+"</li>"}}jQuery(autocomplete_data.list).html(matchesList);var tinymcePosition=jQuery(ed.getContainer()).position();var toolbarPosition=jQuery(ed.getContainer()).find(".mceToolbar").first();var nodePosition=jQuery(ed.selection.getNode()).position();var textareaTop=0;var textareaLeft=0;if(ed.selection.getRng().getClientRects().length>0){textareaTop=ed.selection.getRng().getClientRects()[0].top+ed.selection.getRng().getClientRects()[0].height;textareaLeft=ed.selection.getRng().getClientRects()[0].left}else{textareaTop=parseInt(jQuery(ed.selection.getNode()).css("font-size"))*1.3+nodePosition.top;textareaLeft=nodePosition.left}jQuery(autocomplete_data.list).css("margin-top",tinymcePosition.top+toolbarPosition.innerHeight()+textareaTop);jQuery(autocomplete_data.list).css("margin-left",tinymcePosition.left+textareaLeft);jQuery(autocomplete_data.list).css("display","block");autocomplete_data.visible=true;optionListEventHandlers(ed)}function optionListEventHandlers(ed){jQuery(autocomplete_data.list).find("li").hover(function(){jQuery(autocomplete_data.list).find("[data-selected=true]").attr("data-selected","false");jQuery(this).attr("data-selected","true")});jQuery(autocomplete_data.list).find("li").click(function(){selectOption(ed,getCurrentWord(ed))})}function createOptionList(){var ulContainer=document.createElement("ul");jQuery(ulContainer).addClass("auto-list");document.body.appendChild(ulContainer);return ulContainer}function hideOptionList(){jQuery(autocomplete_data.list).css("display","none");autocomplete_data.visible=false}function highlightNextOption(){var current=jQuery(autocomplete_data.list).find("[data-selected=true]");if(current.size()==0||current.next().size()==0){jQuery(autocomplete_data.list).find("li:first-child").attr("data-selected","true")}else{current.next().attr("data-selected","true")}current.attr("data-selected","false")}function highlightPreviousOption(){var current=jQuery(autocomplete_data.list).find("[data-selected=true]");if(current.size()==0||current.prev().size()==0){jQuery(autocomplete_data.list).find("li:last-child").attr("data-selected","true")}else{current.prev().attr("data-selected","true")}current.attr("data-selected","false")}function selectOption(ed,matchedText){var current=jQuery(autocomplete_data.list).find("[data-selected=true]").attr("data-value");if(current==null){current=jQuery(autocomplete_data.list).find("li:first-child").attr("data-value")}var content=restOfContent(ed.selection.getSel().anchorNode,"");var currentNode=ed.selection.getSel().anchorNode.textContent;var range=ed.selection.getRng();range.setStart(range.startContainer,range.startOffset-matchedText.length);ed.selection.setRng(range);var delim="";if(autocomplete_data.delimiter.length>0){delim=String.fromCharCode(autocomplete_data.delimiter[0])}ed.selection.setContent(autocomplete_data.trigger+current+delim);if(autocomplete_data.enclosing.length>0&&!closingTextExists(content,currentNode)){var middleBookmark=ed.selection.getBookmark();ed.selection.setContent(delim+autocomplete_data.trigger+autocomplete_data.enclosing);ed.selection.moveToBookmark(middleBookmark)}hideOptionList();if(autocomplete_data.onSelect){t.onSelect.dispatch(ed,current)}hideOptionList()}function closingTextExists(content,currentNode){var enclosed=autocomplete_data.trigger+autocomplete_data.enclosing;content=content.substr(currentNode.length);var matches=new RegExp(autocomplete_data.trigger+".{"+autocomplete_data.enclosing.length+"}","g").exec(content);if(matches!=null&&matches.length>0&&matches[0]==enclosed){return true}return false}function restOfContent(anchorNode,content){content+=anchorNode.textContent;if(anchorNode.nextSibling!=null){return restOfContent(anchorNode.nextSibling,content)}return content}function matchingOptions(currentWord){var options=autocomplete_data.options;var matches=[];for(var i in options){if(options[i].key==null&&(currentWord.length==0||beginningOfWordMatches(currentWord,options[i]))){matches.push(options[i])}else if(options[i].key!=null&&(currentWord.length==0||beginningOfWordMatches(currentWord,options[i].key))){matches.push(options[i])}}return matches}function beginningOfWordMatches(beginning,option){var test=new RegExp("^"+beginning,"i");return(option.match(test))}function getCurrentWord(ed){var nodeText=ed.selection.getSel().focusNode==null?"":ed.selection.getSel().focusNode.nodeValue;var positionInNode=ed.selection.getSel().focusOffset;if(nodeText==null||nodeText.length==0){return""}var lastDelimiter=0;for(var i=0;i<positionInNode;i++){if(autocomplete_data.delimiter.indexOf(nodeText.charCodeAt(i).toString())!=-1){lastDelimiter=i+1}}var word=nodeText.substr(lastDelimiter,positionInNode-lastDelimiter);var retWord="";if(autocomplete_data.trigger==''){if(word.length>=autocomplete_data.minLength){retWord=word}}else{if(word.length>0&&word.charAt(0).toString()==autocomplete_data.trigger){retWord=word}}return retWord}ed.onKeyUp.addToTop(keyUpEvent);ed.onKeyDown.addToTop(keyDownEvent);ed.onKeyPress.addToTop(keyPressEvent);ed.onClick.add(clickEvent)},getInfo:function(){return{longname:'AutoComplete',author:'Mijura Pty Ltd',authorurl:'http://mijura.com',infourl:'http://blog.mijura.com',version:tinymce.majorVersion+"."+tinymce.minorVersion}}});tinymce.PluginManager.add('autocomplete',tinymce.plugins.AutoCompletePlugin)})();
